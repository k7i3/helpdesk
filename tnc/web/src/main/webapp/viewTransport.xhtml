<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
        >

<ui:composition template="layout.xhtml">

    <ui:define name="title">
        <p:outputLabel>
            Транспорт
        </p:outputLabel>
    </ui:define>

    <ui:define name="content">
        <p:tabView id="transportTabView" dynamic="true" cache="true" style="font-size: small">
            <p:tab title="Транспорт">
                <p:dataTable id="transportTable"
                             widgetVar="transportTable"
                             var="transport"
                             value="#{transportController.transport}"
                             varStatus="transportVarStatus"
                             filteredValue="#{transportController.filteredTransport}"
                             selection="#{transportController.checkboxSelectedTransport}"
                             rowKey="#{transport.id}"
                             emptyMessage="транспорт не найден..."
                             draggableColumns="true"
                             draggableRows="false"
                             resizableColumns="true"
                             stickyHeader="false"
                             scrollable="false"
                             scrollHeight="500"
                             sortMode="multiple"
                             style="margin-bottom:20px; word-wrap: break-word; table-layout: fixed; white-space: normal" >
                    <!--rowKey="{transport.id}" перестал видеть после добавления varStatus="transportVarStatus"-->

                    <!--TODO смена цвета rowStyleClass="{transport.terminal.number le 7000 ? 'tooday' : 'notTooday'}"-->

                    <f:facet name="header" >
                        <!--<p:outputPanel style="height: 35px">-->
                        <!--<p:panelGrid>-->
                            <p:toolbar>
                                <f:facet name="left">
                                    <p:commandButton type="button" value="New" icon="ui-icon-document" />
                                    <p:commandButton type="button" value="Open" icon="ui-icon-folder-open" />

                                    <span class="ui-separator">
                                        <span class="ui-icon ui-icon-grip-dotted-vertical" />
                                    </span>

                                    <p:commandButton type="button" title="Save" icon="ui-icon-disk" />
                                    <p:commandButton type="button" title="Delete" icon="ui-icon-trash" />
                                    <p:commandButton type="button" title="Print" icon="ui-icon-print" />

                                    <span class="ui-separator">
                                        <span class="ui-icon ui-icon-grip-dotted-vertical" />
                                    </span>

                                    <p:menuButton value="Options">
                                        <p:menuitem value="Save"  icon="ui-icon-disk" />
                                        <p:menuitem value="Update"  icon="ui-icon-arrowrefresh-1-w" />
                                        <p:menuitem value="Delete"  icon="ui-icon-close" />
                                        <p:menuitem value="Homepage" url="http://www.primefaces.org" icon="ui-icon-extlink" />
                                    </p:menuButton>
                                </f:facet>

                                <f:facet name="right">
                                    <p:inputText id="globalFilter" onkeyup="PF('transportTable').filter()" placeholder="поиск..."  />

                                    <span class="ui-separator">
                                        <span class="ui-icon ui-icon-grip-dotted-vertical" />
                                    </span>

                                    <p:commandButton id="transportToggler" type="button"  icon="ui-icon-calculator" />
                                    <p:columnToggler datasource="transportTable" trigger="transportToggler" />
                                </f:facet>

                            </p:toolbar>
                        <!--</p:panelGrid>-->
                        <!--</p:outputPanel>-->
                    </f:facet>

                    <p:column headerText="+" selectionMode="multiple" style="width:16px;text-align:center"/>

                    <p:column headerText="i" style="width:16px">
                        <p:rowToggler />
                    </p:column>

                    <p:column headerText="Проект" sortBy="#{transport.project}" filterBy="#{transport.project}" filterMatchMode="in">
                        <f:facet name="filter">
                            <p:selectCheckboxMenu label="..." onchange="PF('transportTable').filter()" panelStyle="width:200px" scrollHeight="200">
                                <f:selectItems value="#{transportController.projects}" />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{transport.project}" />
                    </p:column>

                    <p:column headerText="Филиал" sortBy="#{transport.branch}" filterBy="#{transport.branch}" filterMatchMode="in">
                        <f:facet name="filter">
                            <p:selectCheckboxMenu label="..." onchange="PF('transportTable').filter()" panelStyle="width:200px" scrollHeight="200">
                                <f:selectItems value="#{transportController.branches}" />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{transport.branch}" />
                    </p:column>

                    <p:column headerText="Гос. номер" sortBy="#{transport.stateNumber}" filterBy="#{transport.stateNumber}" filterMatchMode="contains">
                        <h:outputText value="#{transport.stateNumber}" />
                    </p:column>

                    <p:column headerText="Гар. номер" sortBy="#{transport.garageNumber}" filterBy="#{transport.garageNumber}" filterMatchMode="contains">
                        <h:outputText value="#{transport.garageNumber}" />
                    </p:column>

                    <p:column headerText="Модель" sortBy="#{transport.model}" filterBy="#{transport.model}" filterMatchMode="in">
                        <f:facet name="filter">
                            <p:selectCheckboxMenu label="..." onchange="PF('transportTable').filter()" panelStyle="width:200px" scrollHeight="200">
                                <f:selectItems value="#{transportController.models}" />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{transport.model}" />
                    </p:column>

                    <p:column headerText="Терминал" sortBy="#{transport.terminal.number}" filterBy="#{transport.terminal.number}" filterMatchMode="contains">
                        <h:outputText value="#{transport.terminal.number}" />
                    </p:column>

                    <p:column headerText="Прошивка" sortBy="#{transport.terminal.firmware}" filterBy="#{transport.terminal.firmware}" filterMatchMode="in">
                        <f:facet name="filter">
                            <p:selectCheckboxMenu label="..." onchange="PF('transportTable').filter()" panelStyle="width:200px" scrollHeight="200">
                                <f:selectItems value="#{transportController.firmware}" />
                            </p:selectCheckboxMenu>
                        </f:facet>
                        <h:outputText value="#{transport.terminal.firmware}" />
                    </p:column>

                    <p:column headerText="Телефон" sortBy="#{transport.terminal.mobile}" filterBy="#{transport.terminal.mobile}" filterMatchMode="contains">
                        <h:outputText value="#{transport.terminal.mobile}" />
                    </p:column>

                    <p:column headerText="Связь" sortBy="#{transport.terminal.lastPoint.date}" filterBy="#{transport.terminal.lastPoint.date}" filterMatchMode="contains">

                        <!--style="white-space: normal"-->

                        <!--<p:commandButton id="transportPointButton" update=":form:transportPointPanel" oncomplete="PF('transportPointDialog').show()" icon="ui-icon-pin-s" title="View">-->
                            <!--<f:setPropertyActionListener value="#{transport.terminal.lastPoint}" target="#{transportController.dialogSelectedPoint}" />-->
                        <!--</p:commandButton>-->

                        <h:outputText value="#{transport.terminal.lastPoint.date}" />
                    </p:column>

                    <p:column headerText="Заявки" sortBy="#{transport.terminal.tickets.size()}" filterBy="#{transport.terminal.tickets.size()}" filterMatchMode="contains">
                        <h:outputText value="#{transport.terminal.tickets.size()}" />
                    </p:column>

                    <p:column headerText="Комментарии" sortBy="#{transport.comments.size()}" filterBy="#{transport.comments.size()}" filterMatchMode="contains">

                        <!--<p:commandButton id="transportCommentsButton" update=":form:transportCommentsPanel" oncomplete="PF('transportCommentsDialog').show()" icon="ui-icon-search" title="View">-->
                            <!--<f:setPropertyActionListener value="#{transport}" target="#{transportController.dialogSelectedTransport}" />-->
                        <!--</p:commandButton>-->

                        <h:outputText value="#{transport.comments.size()}" />
                    </p:column>

                    <p:rowExpansion>
                        <p:panelGrid style="margin-bottom: 20px">
                            <p:commandButton id="transportPointButton" update=":form:transportPointPanel" oncomplete="PF('transportPointDialog').show()" icon="ui-icon-pin-s" title="View">
                                <f:setPropertyActionListener value="#{transport.terminal.lastPoint}" target="#{transportController.dialogSelectedPoint}" />
                            </p:commandButton>
                            <p:commandButton id="transportCommentsButton" update=":form:transportCommentsPanel" oncomplete="PF('transportCommentsDialog').show()" icon="ui-icon-search" title="View">
                                <f:setPropertyActionListener value="#{transport}" target="#{transportController.dialogSelectedTransport}" />
                            </p:commandButton>
                        </p:panelGrid>

                        <p:accordionPanel multiple="true" activeIndex="" style="margin-bottom: 20px">
                            <p:tab title="Информация">
                                <p:panelGrid>
                                    <h:outputText value="проект: #{transport.project} - #{transport.branch}" style="display:block"/>
                                    <h:outputText value="транспорт: #{transport.stateNumber} - #{transport.garageNumber} - #{transport.model}" style="display:block"/>
                                    <h:outputText value="терминал: #{transport.terminal.number} - серийник - #{transport.terminal.firmware} - #{transport.terminal.mobile} - #{transport.terminal.lastPoint.date}" style="display:block"/>
                                    <h:outputText value="комплект: " style="display:block"/>
                                </p:panelGrid>
                            </p:tab>

                            <p:tab title="Комментарии к транспорту">
                                <!--<p:panelGrid columns="1">-->
                                    <ui:repeat value="#{transport.comments}" var="transportComment">
                                        <p:fieldset legend="(#{transportComment.createDate}) #{transportComment.owner}:" toggleable="true" toggleSpeed="500" collapsed="true">
                                            <p:panelGrid>
                                                <h:outputText value="#{transportComment.content}" style="width:100%; display:block; word-wrap: break-word; font-style: italic; white-space: normal"/> <!--word-break: break-all;-->
                                                <h:outputText value=" изменен: #{transportComment.updateDate}" style="width:100%; display:block; word-wrap: break-word; font-style: normal; font-weight: bold; white-space: normal"/>
                                            </p:panelGrid>
                                        </p:fieldset>
                                    </ui:repeat>
                                <!--</p:panelGrid>-->
                            </p:tab>

                            <p:tab title="Заявки">
                                <ui:repeat value="#{transport.terminal.tickets}" var="ticket" varStatus="ticketVarStatus">
                                    <p:panel id="ticketPanel#{ticketVarStatus.index}-#{ticket.id}" collapsed="true" toggleable="true" closable="true" toggleSpeed="500" closeSpeed="500" widgetVar="ticketPanel#{ticketVarStatus.index}-#{ticket.id}" style="margin-bottom: 10px"
                                             header="#{ticketVarStatus.index + 1} (#{ticket.ticketStatus}) #{ticket.ticketHeader}"
                                             footer="открыта: #{ticket.createDate} (#{ticket.openedBy}) / изменена: #{ticket.updateDate} () / закрыта: #{ticket.closeDate} (#{ticket.closedBy})">
                                        <!--<p:ajax event="close" listener="{panelView.onClose}" update="msgs" />-->
                                        <!--<p:ajax event="toggle" listener="{panelView.onToggle}" update="msgs" />-->
                                        <ui:repeat value="#{ticket.comments}" var="ticketComment">
                                            <p:fieldset legend="(#{ticketComment.createDate}) #{ticketComment.owner}:" toggleable="true" toggleSpeed="500" collapsed="true">
                                                <p:panelGrid>
                                                    <h:outputText value="#{ticketComment.content}" style="width:100%; display:block; word-wrap: break-word; font-style: italic; white-space: normal"/> <!--word-break: break-all;-->
                                                    <h:outputText value=" изменен: #{ticketComment.updateDate}" style="width:100%; display:block; word-wrap: break-word; font-style: normal; font-weight: bold; white-space: normal"/>
                                                </p:panelGrid>
                                            </p:fieldset>
                                        </ui:repeat>
                                        <!--<f:facet name="options">-->
                                            <!--<p:menu>-->
                                                <!--<p:submenu label="Settings">-->
                                                    <!--<p:menuitem value="Toggle" url="#" icon="ui-icon-newwin" onclick="PF('ticketPanel{transportVarStatus.index}{ticketVarStatus.index}').toggle()" />-->
                                                    <!--<p:menuitem value="Remove" url="#" icon="ui-icon-close" onclick="PF('ticketPanel{transportVarStatus.index}{ticketVarStatus.index}').close()" />-->
                                                <!--</p:submenu>-->
                                            <!--</p:menu>-->
                                        <!--</f:facet>-->
                                        <!--<f:facet name="actions">-->
                                            <!--<h:commandLink styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"><h:outputText styleClass="ui-icon ui-icon-help" /></h:commandLink>-->
                                            <!--<h:commandLink styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"><h:outputText styleClass="ui-icon ui-icon-star" /></h:commandLink>-->
                                        <!--</f:facet>-->
                                    </p:panel>
                                </ui:repeat>
                            </p:tab>
                        </p:accordionPanel>
                    </p:rowExpansion>
                                <!--<c:set var="NOT_ONLINE" value="<=TicketHeader.NOT_ONLINE%>"/>-->
                                <!--<c:set var="BAD_TRACK" value="<=TicketHeader.BAD_TRACK%>"/>-->

                                <!--<c:if test="{!empty ticket}">-->
                                <!--<c:choose>-->
                                <!--<c:when test="{ticket.ticketHeader == NOT_ONLINE}">-->
                                <!--<c:set var="ticketHeader" value="не на связи!!!" />-->
                                <!--</c:when>-->

                                <!--<c:when test="{ticket.ticketHeader == BAD_TRACK}">-->
                                <!--<c:set var="ticketHeader" value="некорректный трек!!!" />-->
                                <!--</c:when>-->

                                <!--<c:otherwise>-->
                                <!--<c:set var="ticketHeader" value="прочее!!!" />-->
                                <!--</c:otherwise>-->
                                <!--</c:choose>-->
                                <!--<h:outputText value="{ticketHeader}" style="display:block"/>-->

                                <!--<c:set value="{ticket.updateDate}" var="ticketUpdateDate"/>-->
                                <!--<c:if test="{not empty ticketUpdateDate}">-->
                                    <!--<h:outputText value="(обновлена!!!: {ticketUpdateDate})"/>-->
                                <!--</c:if>-->

                                <!--<c:set value="{ticket.closeDate}" var="tiecketClosDate"/>-->
                                <!--<c:if test="{not empty fn:trim(tiecketClosDate)}">-->
                                    <!--<h:outputText value="(закрыта!!!: {tiecketClosDate} / {ticket.closedBy})"/>-->
                                <!--</c:if>-->
                                <!--</c:if>-->
                    <f:facet name="footer">
                        <h:outputText value="всего в базе: #{fn:length(transportController.transport)}" style="font-size: small; text-align:left"/>
                    </f:facet>

                </p:dataTable>
            </p:tab>

            <p:tab title="В норме">
            </p:tab>

            <p:tab title="Заявки">
            </p:tab>

            <p:tab title="Статистика">
            </p:tab>

            <p:tab title="TEST" titleStyle="float: right">
                <p:dataTable var="transport" value="#{transportEJB.findAllTransport()}">
                    <p:column headerText="BD_Id_Transport">
                        <h:outputText value="#{transport.id}" />
                    </p:column>

                    <p:column headerText="Проект">
                        <h:outputText value="#{transport.project}" />
                    </p:column>

                    <p:column headerText="Филиал">
                        <h:outputText value="#{transport.branch}" />
                    </p:column>

                    <p:column headerText="Гос. номер">
                        <h:outputText value="#{transport.stateNumber}" />
                    </p:column>

                    <p:column headerText="Гар. номер">
                        <h:outputText value="#{transport.garageNumber}" />
                    </p:column>

                    <p:column headerText="Модель">
                        <h:outputText value="#{transport.model}" />
                    </p:column>

                    <p:column headerText="BD_Id_Terminal">
                        <h:outputText value="#{transport.terminal.id}" />
                    </p:column>

                    <p:column headerText="Терминал">
                        <h:outputText value="#{transport.terminal.number}" />
                    </p:column>

                    <p:column headerText="Прошивка">
                        <h:outputText value="#{transport.terminal.firmware}" />
                    </p:column>

                    <p:column headerText="Телефон">
                        <h:outputText value="#{transport.terminal.mobile}" />
                    </p:column>

                    <p:column headerText="BD_Id_Point">
                        <h:outputText value="#{transport.terminal.lastPoint.id}" />
                    </p:column>

                    <p:column headerText="longitude">
                        <h:outputText value="#{transport.terminal.lastPoint.longitude}" />
                    </p:column>

                    <p:column headerText="latitude">
                        <h:outputText value="#{transport.terminal.lastPoint.latitude}" />
                    </p:column>

                    <p:column headerText="Связь">
                        <h:outputText value="#{transport.terminal.lastPoint.date}" />
                    </p:column>

                    <p:column headerText="Заявки">
                        <h:outputText value="#{transport.terminal.tickets.size()}" />
                    </p:column>

                    <p:column headerText="Комментарии">
                        <h:outputText value="#{transport.comments.size()}" />
                    </p:column>
                </p:dataTable>
            </p:tab>

        </p:tabView>

        <p:dialog
                widgetVar="transportPointDialog"
                header="Карта:"
                modal="true"
                showEffect="fade"
                hideEffect="fade"
                resizable="false"
                draggable="false"
                width="50%">
            <!--id="transportPointDialog"-->
            <!--width="625"-->
            <!--height="400"-->


            <p:outputPanel id="transportPointPanel">
                <p:gmap id="gmap" center="#{transportController.dialogSelectedPoint.longitude}, #{transportController.dialogSelectedPoint.latitude}" zoom="15" type="HYBRID" style="width:100%; height:500px" />
            </p:outputPanel>

        </p:dialog>

        <p:dialog
                widgetVar="transportCommentsDialog"
                header="Комментарии:"
                modal="true"
                showEffect="fade"
                hideEffect="fade"
                resizable="false"
                draggable="false"
                width="80%">
            <!--id="transportCommentsDialog"-->
            <!--modal="true" showEffect="explode""fade" hideEffect="bounce""fade" resizable="false"-->
            <p:outputPanel id="transportCommentsPanel">

                <!--style="text-align:center"-->

                <!--<ui:repeat value="{transportController.dialogSelectedTransport.comments}" var="comment1">-->
                    <!--<h:outputText value="{comment1.owner} - {comment1.content}" style="display:block"/>-->
                <!--</ui:repeat>-->

                <p:commandButton id="testButton1" onclick="PF('transportPointDialog').show()" icon="ui-icon-pin-s" title="View" style="height: 30px">
                </p:commandButton>

                <p:dataTable id="transportCommentsTable"
                             widgetVar="transportCommentsTableWidget"
                             var="comment"
                             value="#{transportController.dialogSelectedTransport.comments}"
                             filteredValue="#{transportController.filteredTransportComments}"
                             emptyMessage="комментарии не найдены..."
                             draggableColumns="true"
                             draggableRows="false"
                             resizableColumns="true"
                             stickyHeader="false"
                             scrollable="false"
                             scrollHeight="500"
                             sortMode="multiple"
                             style="margin-bottom:20px">

                    <f:facet name="header" >
                        <p:outputPanel style="height: 30px">
                            <p:inputText id="transportCommentsGlobalFilter" onkeyup="PF('transportCommentsTableWidget').filter()" style="width:200px; height: 20px; float:right"  placeholder=""  />
                            <p:commandButton id="transportCommentsToggler" type="button" style="float:right; height: 30px" icon="ui-icon-calculator" />
                            <p:columnToggler datasource="transportCommentsTable" trigger="transportCommentsToggler" />
                        </p:outputPanel>
                    </f:facet>

                    <p:column headerText="Автор" sortBy="#{comment.owner}" filterBy="#{comment.owner}" filterMatchMode="contains">
                        <h:outputText value="#{comment.owner}" />
                    </p:column>

                    <p:column headerText="Создан" sortBy="#{comment.createDate}" filterBy="#{comment.createDate}" filterMatchMode="contains">
                        <h:outputText value="#{comment.createDate}" />
                    </p:column>

                    <p:column headerText="Изменен" sortBy="#{comment.updateDate}" filterBy="#{comment.updateDate}" filterMatchMode="contains">
                        <h:outputText value="#{comment.updateDate}" />
                    </p:column>

                    <p:column headerText="Удален" sortBy="#{comment.deleteDate}" filterBy="#{comment.deleteDate}" filterMatchMode="contains">
                        <h:outputText value="#{comment.deleteDate}" />
                    </p:column>

                    <p:column headerText="Комментарий" sortBy="#{comment.content}" filterBy="#{comment.content}" filterMatchMode="contains">
                        <h:outputText value="#{comment.content}" />
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value="всего в базе: #{fn:length(transportController.dialogSelectedTransport.comments)}" style="font-size: small; text-align:left"/>
                    </f:facet>

                </p:dataTable>

            </p:outputPanel>
        </p:dialog>
    </ui:define>

</ui:composition>
</html>
